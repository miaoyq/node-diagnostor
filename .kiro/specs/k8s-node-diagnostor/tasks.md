# K8s节点诊断工具实现计划

## 概述
本实现计划基于需求和设计文档，将功能拆分为可执行的编码任务。每个任务都明确关联到具体的需求编号，确保所有17个需求都被覆盖。

## 实现任务清单

### 1. 项目基础架构搭建
- [x] 1.1 创建Clean Architecture项目结构
  - 建立 `cmd/node-diagnostor/` 主程序入口
  - 建立 `internal/` 核心应用逻辑目录
  - 建立 `pkg/` 共享工具和包目录
  - 建立 `configs/` 配置模板目录
  - 建立 `test/` 测试工具目录
  - _需求：架构模式、项目结构指南_

- [x] 1.2 初始化Go模块和依赖管理
  - 创建 `go.mod` 并设置模块路径
  - 添加必要的第三方依赖（fsnotify, zap, testify等）
  - 创建 `.gitignore` 和 `Makefile`
  - _需求：工具和依赖项_

### 2. 配置管理系统
- [x] 2.1 实现配置结构定义
  - 定义 `Config` 结构体（版本、检查项、资源限制、数据范围、上报配置）
  - 定义 `CheckConfig` 结构体（名称、间隔、采集器、参数、模式等）
  - 定义 `ResourceLimits` 结构体（CPU、内存、并发限制）
  - 定义 `DataScopeConfig` 结构体（数据范围模式配置）
  - _需求：4.1, 4.2, 4.3, 需求17_

- [x] 2.2 实现配置管理器（ConfigManager）
  - 实现配置文件的加载和解析
  - 实现基于fsnotify的配置热更新（1秒内响应）
  - 实现配置版本兼容性检查
  - 实现配置验证和错误处理
  - _需求：4.1, 4.3, 错误处理_

- [x] 2.3 实现配置验证器
  - 验证检查项参数的有效性
  - 验证采集器ID的合法性
  - 验证时间间隔的合理范围
  - 提供详细的配置错误提示
  - _需求：配置验证机制_

### 3. 数据范围检查系统
- [x] 3.1 实现数据类型映射器
  - 创建节点本地独有数据类型白名单
  - 创建集群级数据类型黑名单
  - 创建集群补充数据类型定义
  - 实现数据类型的预定义映射
  - _需求：需求17_

- [x] 3.2 实现数据范围检查器（DataScopeChecker）
  - 实现"仅本地"模式的严格验证
  - 实现"集群补充"模式的智能选择
  - 实现"自动选择"模式的智能判断
  - 实现基于LRU缓存的结果缓存
  - _需求：需求17_

- [x] 3.3 实现数据类型验证器
  - 验证采集器是否为节点本地独有
  - 验证采集器是否为集群补充数据
  - 提供详细的跳过原因记录
  - 提供替代采集器建议
  - 生成完整的验证报告
  - _需求：需求17_

### 4. 资源限制和监控
- [x] 4.1 实现资源监控器（ResourceMonitor）
  - 实现CPU使用率监控（<5%限制）
  - 实现内存使用率监控（<100MB限制）
  - 实现进程级资源使用统计
  - _需求：5.1, 5.2_

- [x] 4.2 实现资源管理器（ResourceManager）
  - 实现资源使用限制检查
  - 实现基于优先级的检查项降级
  - 实现资源紧张时的自动限流
  - 实现资源恢复后的自动恢复
  - _需求：5.1, 5.2, 5.3_

- [x] 4.3 实现限流器（Throttler）
  - 实现CPU限流策略（延长检查间隔）
  - 实现内存限流策略（跳过低优先级）
  - 实现指数退避重试机制
  - _需求：5.1, 5.2_

### 5. 数据采集系统
- [x] 5.1 实现采集器接口（Collector）
  - 定义统一的采集器接口
  - 实现采集器注册机制
  - 实现采集器生命周期管理
  - _需求：架构设计_

- [x] 5.2 实现节点本地采集器
  - 实现CPU相关采集器（温度、频率、限流事件）
  - 实现内存相关采集器（碎片、swap、OOM事件）
  - 实现磁盘相关采集器（SMART、错误、性能）
  - 实现网络相关采集器（接口错误、TCP重传）
  - _需求：需求17, 节点本地数据定义_

- [x] 5.3 实现K8s组件本地采集器，日志采集需要通过 journalctl 命令
  - 实现kubelet状态采集器（进程、日志、证书）
  - 实现containerd状态采集器（内存、日志、配置）
  - 实现CNI插件状态采集器
  - 实现kube-proxy状态采集器
  - **实现异步日志监听机制，避免资源消耗过大**
  - _需求：需求17, K8s组件本地状态_

- [x] 5.4 实现系统级采集器
  - 实现系统负载采集器
  - 实现文件描述符采集器
  - 实现内核日志采集器
  - 实现NTP同步状态采集器
  - _需求：需求17, 系统级本地状态_

- [x] 5.5 实现集群补充采集器
  - 实现进程级资源使用采集器
  - 实现内核事件采集器
  - 实现配置文件状态采集器
  - 实现证书有效期采集器
  - 添加集群补充采集器注册函数
  - _需求：需求17, 集群补充数据_

### 6. 检查项调度系统
- [x] 6.1 实现检查项调度器（CheckScheduler）
  - 实现基于固定周期的检查调度
  - 实现检查项的并发控制（最大并发数=1）
  - 实现检查项的优先级管理
  - 实现检查项的错误重试机制
  - _需求：2.1, 2.2, 5.3_

- [x] 6.2 实现定时任务管理
  - 实现基于time.Ticker的精确调度
  - 实现检查项的启动/停止控制
  - 实现检查项的状态跟踪
  - _需求：2.1, 2.2_

- [x] 6.3 实现检查执行引擎
  - 实现检查项的完整执行流程
  - 实现超时保护机制
  - 实现错误处理和恢复
  - _需求：超时保护器_

### 7. 超时保护系统
- [x] 7.1 实现超时管理器（TimeoutManager）
  - 实现基于context的超时控制
  - 实现检查项级别的超时配置
  - 实现超时后的资源清理
  - 实现超时统计和监控
  - _需求：超时保护_

- [x] 7.2 实现执行上下文管理
  - 实现活动执行的跟踪
  - 实现强制终止机制
  - 实现超时日志记录
  - _需求：超时保护_

### 8. 数据聚合和上报
- [x] 8.1 实现数据聚合器（DataAggregator）
  - 实现按检查项的数据分组
  - 实现数据格式标准化
  - 实现数据压缩和优化
  - _需求：3.1, 3.3_

- [x] 8.2 实现上报客户端（ReporterClient）
  - 实现HTTP POST数据上报
  - 实现失败重试机制（指数退避）
  - 实现本地数据缓存（TTL管理）
  - 实现上报状态监控
  - _需求：3.2, 3.3_

- [x] 8.3 实现缓存管理器
  - 实现基于TTL的缓存清理
  - 实现缓存大小限制（默认100MB）
  - 实现缓存持久化（重启后恢复）
  - 实现缓存统计和监控
  - _需求：3.3_

### 9. 错误处理和恢复
- [x] 9.1 实现配置错误处理器
  - 实现配置格式错误的处理
  - 实现配置参数错误的处理
  - 实现配置回退机制
  - 实现配置文件备份和恢复
  - 实现详细的错误日志记录
  - _需求：错误处理_

- [ ] 9.2 实现采集错误处理器
  - 实现采集失败的错误处理
  - 实现权限错误的处理
  - 实现资源不足的错误处理
  - _需求：错误处理_

- [ ] 9.3 实现上报错误处理器
  - 实现网络故障的错误处理
  - 实现服务端错误的处理
  - 实现数据格式错误的处理
  - _需求：错误处理_

### 10. 测试系统
- [x] 10.1 实现单元测试
  - 为每个组件编写单元测试
  - 实现表驱动测试模式
  - 实现mock对象和接口
  - _需求：测试策略1_

- [x] 10.2 实现集成测试
  - 实现配置热更新测试
  - 实现固定周期测试
  - 实现错误恢复测试
  - 实现数据范围模式测试
  - _需求：测试策略2_

- [ ] 10.3 实现性能测试
  - 实现内存使用测试（<100MB）
  - 实现CPU使用测试（<5%）
  - 实现长时间运行测试
  - _需求：测试策略3_

- [ ] 10.4 实现扩展性测试
  - 实现动态注册测试
  - 实现配置组合测试
  - 实现错误隔离测试
  - _需求：测试策略4_

### 11. 部署和运维
- [ ] 11.1 实现部署脚本
  - 创建二进制构建脚本
  - 创建容器化部署配置
  - 创建systemd服务配置
  - _需求：部署方式_

- [ ] 11.2 实现运维接口
  - 实现HTTP健康检查端点
  - 实现Prometheus指标暴露
  - 实现配置重载接口
  - _需求：运维接口_

- [ ] 11.3 实现监控告警
  - 实现资源使用告警
  - 实现检查失败告警
  - 实现配置错误告警
  - _需求：监控告警_

### 12. 文档和示例
- [ ] 12.1 创建配置示例
  - 创建完整的配置示例文件
  - 创建各模式的配置模板
  - 创建采集器配置说明
  - _需求：文档和标准_

- [ ] 12.2 创建部署文档
  - 创建二进制部署指南
  - 创建容器部署指南
  - 创建Kubernetes部署指南
  - _需求：文档和标准_

- [ ] 12.3 创建运维手册
  - 创建故障排查指南
  - 创建性能调优指南
  - 创建扩展开发指南
  - _需求：文档和标准_

## 需求映射表

| 需求编号 | 覆盖任务 |
|---------|----------|
| 需求1   | 1.1, 1.2 |
| 需求2   | 2.1, 2.2 |
| 需求3   | 2.1, 2.2 |
| 需求4   | 2.1, 2.2 |
| 需求5   | 4.1, 4.2, 4.3 |
| 需求6   | 4.1, 4.2, 4.3 |
| 需求7   | 4.1, 4.2, 4.3 |
| 需求8   | 5.1, 5.2, 5.3, 5.4, 5.5 |
| 需求9   | 5.1, 5.2, 5.3, 5.4, 5.5 |
| 需求10  | 5.1, 5.2, 5.3, 5.4, 5.5 |
| 需求11  | 5.1, 5.2, 5.3, 5.4, 5.5 |
| 需求12  | 5.1, 5.2, 5.3, 5.4, 5.5 |
| 需求13  | 8.1, 8.2, 8.3 |
| 需求14  | 8.1, 8.2, 8.3 |
| 需求15  | 8.1, 8.2, 8.3 |
| 需求16  | 9.1, 9.2, 9.3 |
| 需求17  | 3.1, 3.2, 3.3, 5.2, 5.3, 5.4, 5.5 |

## 实施建议

1. **优先级排序**：
   - 高优先级：1-4（基础架构和配置）
   - 中优先级：5-8（核心功能）
   - 低优先级：9-12（测试和运维）

2. **开发顺序**：
   - 先实现基础架构和配置管理
   - 再实现数据范围检查和资源限制
   - 然后实现各类采集器
   - 最后实现测试和运维功能

3. **测试驱动**：
   - 每个功能模块都先写测试
   - 使用表驱动测试模式
   - 确保测试覆盖率>80%

4. **渐进式开发**：
   - 先实现最小可用版本
   - 逐步添加更多采集器
   - 持续集成和部署