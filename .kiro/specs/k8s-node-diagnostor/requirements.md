# K8s节点诊断工具需求文档

## 介绍
本工具用于监控K8s节点健康状态，通过轻量级后台进程收集节点指标、日志及进程信息，实现分钟级异常检测与上报。工具采用配置驱动的架构设计，支持检查项和数据采集功能的灵活扩展。

## 需求

### 需求1：轻量级后台服务
**用户故事**：作为集群管理员，我需要工具以节点进程方式运行，确保在节点异常时仍能收集关键数据，同时保持最小内存占用

#### 验收标准
1. WHEN 部署到节点 THEN 工具SHALL以独立进程形式运行（非DaemonSet）
2. WHEN 运行时 THEN 工具SHALL通过优化数据结构和算法实现最小内存占用，优先使用顺序处理而非并发
3. WHEN 运行时 THEN 工具SHALL避免动态调整采集频率，保持配置指定的固定周期，通过时间换空间策略减少内存占用

### 需求2：配置驱动的数据采集
**用户故事**：作为SRE工程师，我需要通过配置精确控制采集哪些指标和日志，避免采集无关数据

#### 验收标准
1. WHEN 配置文件中定义检查项 THEN 系统SHALL仅采集配置中明确指定的指标和日志
2. WHEN 配置中未包含某项检查 THEN 系统SHALL完全跳过该项的数据采集
3. WHEN 配置变更时 THEN 系统SHALL在1秒内检测到变更并加载新配置并按新配置执行采集
4. WHEN 配置指定采集周期 THEN 系统SHALL严格按照配置周期执行，不受节点资源影响

### 需求3：检查项配置规范
**用户故事**：作为运维人员，我需要灵活配置每个检查项的详细采集策略

#### 验收标准
1. WHEN 配置检查项 THEN 配置SHALL包含：检查周期、检查项名称、所需采集功能列表
2. WHEN 配置检查项 THEN 每个采集功能SHALL可配置具体参数（如指标类型、日志路径/模块、匹配模式）
3. WHEN 配置检查项 THEN 支持为不同检查项设置不同检查周期（1min~60min，分钟级精度）
4. WHEN 配置检查项 THEN 支持启用/禁用单个检查项而不影响其他项

### 需求4：可扩展的检查项架构
**用户故事**：作为开发者，我需要添加新的检查项而无需修改核心框架代码

#### 验收标准
1. WHEN 新增检查项 THEN 系统SHALL通过配置注册新检查项，无需修改代码框架
2. WHEN 新增检查项 THEN 检查项SHALL可复用现有采集功能或定义新的采集功能
3. WHEN 新增采集功能 THEN 系统SHALL支持通过插件机制注册新采集器
4. WHEN 检查项配置错误 THEN 系统SHALL记录错误并继续执行其他有效检查项

### 需求5：检查项与数据采集解耦
**用户故事**：作为架构师，我需要检查项和数据采集功能完全解耦，支持灵活组合

#### 验收标准
1. WHEN 定义检查项 THEN 检查项SHALL通过引用采集功能ID来组合所需数据
2. WHEN 多个检查项使用同一采集功能 THEN 系统SHALL复用采集结果，避免重复采集
3. WHEN 单个检查项需要多种数据 THEN 检查项SHALL可组合多个采集功能的结果
4. WHEN 采集功能更新 THEN 所有引用该功能的检查项SHALL自动使用更新后的采集逻辑

### 需求6：数据上报格式
**用户故事**：作为监控系统管理员，我需要接收结构化的诊断数据用于分析

#### 验收标准
1. WHEN 上报数据 THEN 数据SHALL仅包含具体采集结果，不包含元数据或配置信息
2. WHEN 上报数据 THEN 数据SHALL按检查项分组，每组包含该检查项的所有采集结果
3. WHEN 上报数据 THEN 数据SHALL包含时间戳、节点标识、检查项名称和采集结果
4. WHEN 上报数据为日志类型 THEN 数据SHALL包含检查周期内所有符合错误条件的日志信息
5. WHEN 上报失败 THEN 系统SHALL将数据暂存本地并按指数退避策略重试

### 需求7：配置热更新
**用户故事**：作为运维人员，我需要配置变更实时生效，无需重启服务

#### 验收标准
1. WHEN 配置文件更新 THEN 系统SHALL在1秒内检测到变更并加载新配置
2. WHEN 配置加载后 THEN 新配置SHALL立即应用于后续的数据采集周期
3. WHEN 配置格式错误 THEN 系统SHALL记录错误并继续使用上一个有效配置
4. WHEN 配置中删除检查项 THEN 系统SHALL立即停止该检查项的数据采集

### 需求8：节点资源使用监控（节点本地独有）
**用户故事**：作为集群管理员，我需要监控节点本地独有的资源使用情况，避免与apiserver重复检查

#### 验收标准
1. WHEN 配置节点本地CPU检查项 THEN 系统SHALL采集CPU throttling事件详情、CPU温度、CPU频率变化（仅节点本地可见）
2. WHEN 配置节点本地内存检查项 THEN 系统SHALL采集内存碎片指标、swap使用率、OOM killer事件详情（仅节点本地可见）
3. WHEN 配置节点本地磁盘检查项 THEN 系统SHALL采集磁盘I/O延迟分布、磁盘错误日志、SMART状态（仅节点本地可见）
4. WHEN 配置节点本地网络检查项 THEN 系统SHALL采集网络接口错误统计、TCP重传率、网络缓冲区状态（仅节点本地可见）
5. WHEN 资源使用超过阈值 THEN 系统SHALL记录具体数值和对应进程信息
6. WHEN apiserver已提供基础资源使用率 THEN 系统SHALL跳过对应检查项避免重复，仅保留节点本地独有指标

### 需求9：K8s核心组件健康检查（节点本地视角）
**用户故事**：作为SRE工程师，我需要从节点本地视角检查K8s组件健康，补充apiserver无法提供的信息

#### 验收标准
1. WHEN 配置kubelet本地检查项 THEN 系统SHALL检查kubelet进程状态、kubelet日志错误、kubelet配置文件完整性、kubelet证书有效期（仅节点本地可见）
2. WHEN 配置容器运行时本地检查项 THEN 系统SHALL检查containerd/docker进程状态、运行时socket响应时间、运行时日志错误、运行时内存使用（仅节点本地可见）
3. WHEN 配置kube-proxy本地检查项 THEN 系统SHALL检查kube-proxy进程状态、本地iptables/ipvs规则同步延迟、kube-proxy本地日志（仅节点本地可见）
4. WHEN 配置CNI插件本地检查项 THEN 系统SHALL检查CNI插件进程状态、CNI配置文件完整性、CNI二进制文件可用性、CNI网络接口状态（仅节点本地可见）
5. WHEN 组件异常 THEN 系统SHALL采集详细错误信息、重启次数、本地日志详情
6. WHEN apiserver已提供组件基础健康状态 THEN 系统SHALL跳过对应检查项避免重复，仅保留节点本地独有细节

### 需求10：容器运行时状态监控（节点本地细节）
**用户故事**：作为运维人员，我需要监控节点本地容器运行时的细节状态，补充apiserver无法获取的信息

#### 验收标准
1. WHEN 配置容器运行时本地检查项 THEN 系统SHALL采集容器运行时socket响应时间、运行时内存使用、运行时goroutine数量、运行时内部指标（仅节点本地可见）
2. WHEN 配置镜像本地检查项 THEN 系统SHALL采集节点镜像层存储分布、镜像拉取失败详情、镜像垃圾回收状态、镜像层碎片情况（仅节点本地可见）
3. WHEN 配置存储驱动本地检查项 THEN 系统SHALL检查存储驱动进程状态、存储驱动日志错误、存储池碎片情况、存储驱动性能指标（仅节点本地可见）
4. WHEN 配置容器cgroup检查项 THEN 系统SHALL采集容器cgroup限制执行情况、容器throttling事件详情、容器资源限制冲突（仅节点本地可见）
5. WHEN 容器运行时异常 THEN 系统SHALL采集容器运行时日志中的详细错误信息
6. WHEN apiserver已提供容器基础状态 THEN 系统SHALL跳过对应检查项避免重复，仅保留节点本地独有细节

### 需求11：网络连通性检查（节点本地网络栈）
**用户故事**：作为网络管理员，我需要验证节点本地网络栈健康状态，避免跨节点检查

#### 验收标准
1. WHEN 配置节点网络接口检查项 THEN 系统SHALL检查本地网络接口状态、MTU配置、错误包统计、接口重置次数
2. WHEN 配置本地DNS解析检查项 THEN 系统SHALL测试节点本地DNS解析功能、缓存命中率、DNS查询延迟
3. WHEN 配置路由表检查项 THEN 系统SHALL验证节点路由表正确性、默认网关可达性、路由表变化
4. WHEN 配置iptables规则检查项 THEN 系统SHALL检查节点本地iptables规则加载状态、规则数量、规则冲突
5. WHEN 网络异常 THEN 系统SHALL采集本地网络配置、接口统计信息、内核网络日志
6. WHEN 执行网络检查时 THEN 系统SHALL限制检查频率不低于5分钟，避免频繁网络探测，仅检查本地网络栈状态

### 需求12：存储状态检查（节点本地存储）
**用户故事**：作为存储管理员，我需要监控节点已挂载存储的健康状态，避免存储后端检查

#### 验收标准
1. WHEN 配置本地存储检查项 THEN 系统SHALL检查节点已挂载本地卷状态、使用率、错误日志、挂载选项
2. WHEN 配置挂载点检查项 THEN 系统SHALL验证挂载点可用性、挂载选项、挂载时间、挂载点权限
3. WHEN 配置文件系统检查项 THEN 系统SHALL检查节点文件系统完整性、只读文件系统事件、文件系统错误
4. WHEN 配置磁盘健康检查项 THEN 系统SHALL采集磁盘SMART信息、磁盘错误计数、磁盘温度、磁盘重映射扇区
5. WHEN 存储异常 THEN 系统SHALL采集节点本地存储相关日志、挂载信息、文件系统事件
6. WHEN 执行存储检查时 THEN 系统SHALL限制I/O测试强度，避免影响业务I/O性能，仅检查本地存储状态

### 需求13：系统级健康检查（节点本地系统）
**用户故事**：作为系统管理员，我需要监控节点系统级健康状态，包括系统负载、文件描述符、进程状态等

#### 验收标准
1. WHEN 配置系统负载检查项 THEN 系统SHALL采集系统负载平均值、进程数、僵尸进程数量、运行队列长度
2. WHEN 配置文件描述符检查项 THEN 系统SHALL采集文件描述符使用率、文件描述符泄漏事件、最大文件描述符限制
3. WHEN 配置系统进程检查项 THEN 系统SHALL检查关键系统进程状态、进程重启事件、进程资源使用、进程信号处理
4. WHEN 配置内核日志检查项 THEN 系统SHALL采集内核错误日志、OOM killer事件详情、内核panic信息、内核警告
5. WHEN 配置时间同步检查项 THEN 系统SHALL检查NTP同步状态、时间漂移量、时间同步错误日志、时钟源状态
6. WHEN 执行系统检查时 THEN 系统SHALL使用轻量级系统调用，避免频繁/proc文件读取，仅检查节点本地系统状态

### 需求14：安全相关检查（节点本地安全）
**用户故事**：作为安全管理员，我需要监控节点本地安全状态，避免集群级安全检查

#### 验收标准
1. WHEN 配置证书检查项 THEN 系统SHALL检查节点本地K8s组件证书有效期、证书过期警告、证书链完整性
2. WHEN 配置权限检查项 THEN 系统SHALL检查节点文件权限异常、特权容器运行、敏感文件访问、SUID/SGID文件
3. WHEN 配置容器安全检查项 THEN 系统SHALL检查节点容器安全策略配置、Seccomp/AppArmor配置、容器特权模式
4. WHEN 配置系统安全日志检查项 THEN 系统SHALL采集节点本地安全相关日志（auth.log、audit.log、sudo日志）
5. WHEN 发现安全异常 THEN 系统SHALL采集节点本地的安全事件信息、用户登录记录、权限变更记录
6. WHEN 执行安全检查时 THEN 系统SHALL限制文件系统扫描范围，避免全系统遍历，仅检查节点本地安全配置

### 需求15：性能监控（轻量级被动监控）
**用户故事**：作为性能工程师，我需要轻量级性能监控，避免基准测试对业务的影响

#### 验收标准
1. WHEN 配置性能监控检查项 THEN 系统SHALL采集轻量级性能指标：CPU使用率趋势、内存使用趋势、系统调用延迟分布
2. WHEN 配置容器性能监控项 THEN 系统SHALL采集容器启动时间统计、容器资源使用快照、容器性能事件
3. WHEN 配置系统性能监控项 THEN 系统SHALL采集系统调用延迟、上下文切换频率、中断处理延迟
4. WHEN 性能异常 THEN 系统SHALL记录性能变化趋势，避免主动性能测试，仅记录被动观察数据
5. WHEN 配置性能阈值 THEN 系统SHALL在性能指标异常时发出告警信息
6. WHEN 执行性能监控时 THEN 系统SHALL使用被动监控，避免主动性能测试和负载生成，仅监控节点本地性能指标

### 需求16：资源限制与保护机制
**用户故事**：作为系统管理员，我需要确保诊断工具本身不会影响节点稳定性

#### 验收标准
1. WHEN 工具运行时 THEN 系统SHALL限制CPU使用率不超过节点CPU的5%
2. WHEN 工具运行时 THEN 系统SHALL限制内存使用不超过100MB
3. WHEN 节点资源紧张时 THEN 系统SHALL自动降低检查频率或暂停非关键检查项
4. WHEN 配置检查项时 THEN 系统SHALL支持为每个检查项设置检查周期（1min~60min，分钟级精度），与需求3保持一致
5. WHEN 检查项执行超时 THEN 系统SHALL强制终止并记录超时事件
6. WHEN 工具异常退出 THEN 系统SHALL优雅退出并释放所有资源

### 需求17：apiserver数据去重机制
**用户故事**：作为系统管理员，我需要确保节点诊断工具不会与apiserver提供的数据重复

#### 验收标准
1. WHEN 启动检查项时 THEN 系统SHALL检测apiserver是否已提供对应数据，基于已知metrics列表
2. WHEN apiserver已提供数据 THEN 系统SHALL标记对应检查项为"已覆盖"并跳过执行，避免重复采集
3. WHEN apiserver数据不可用时 THEN 系统SHALL回退到节点本地检查，确保数据完整性
4. WHEN 配置检查项时 THEN 系统SHALL提供"仅本地"、"仅apiserver"、"自动选择"三种模式
5. WHEN 检查项被跳过 THEN 系统SHALL记录跳过原因和apiserver数据来源，便于审计
6. WHEN apiserver连接失败 THEN 系统SHALL自动启用节点本地检查作为后备，无需人工干预
7. WHEN 执行节点本地检查时 THEN 系统SHALL确保所有检查命令在节点本地执行，不访问apiserver